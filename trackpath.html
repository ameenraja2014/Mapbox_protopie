<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Animate the camera along a road route</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=yes">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
<style>
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>
<body>

<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.3.1/mapbox-gl-directions.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.3.1/mapbox-gl-directions.css" type="text/css">

<div id="map"></div>

<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiYW1lZW5yYWphMjAxNCIsImEiOiJjbHdocHd3dzcwY3Q5MmlueW1oZjl6MHA2In0.HrlG6kGHN1Fi2tHpPiuBeg';
const map = new mapboxgl.Map({
    container: 'map',
    zoom: 14,
    center: [11.4194, 48.7621], // Centering on Ingolstadt
    pitch: 60, // Initial pitch for 3D effect
    bearing: 0,
    style: 'mapbox://styles/mapbox/streets-v11',
    interactive: true
});

const getRoute = async () => {
    try {
        const query = await fetch(
            `https://api.mapbox.com/directions/v5/mapbox/driving/11.431672%2C48.766847%3B11.429286%2C48.753998?alternatives=true&geometries=geojson&language=en&overview=full&steps=true&access_token=${mapboxgl.accessToken}`,
            { method: 'GET' }
        );
        const json = await query.json();
        const route = json.routes[0].geometry.coordinates;
        return route;
    } catch (error) {
        console.error('Error fetching route:', error);
    }
};

const animateRoute = async () => {
    const route = await getRoute();
    if (!route) {
        console.error('No route data available.');
        return;
    }

    const routeDistance = turf.length(turf.lineString(route));

    map.on('load', () => {
        map.addSource('trace', {
            type: 'geojson',
            data: {
                'type': 'Feature',
                'properties': {},
                'geometry': {
                    'type': 'LineString',
                    'coordinates': route
                }
            }
        });

        map.addLayer({
            type: 'line',
            source: 'trace',
            id: 'line',
            paint: {
                'line-color': 'black',
                'line-width': 5
            },
            layout: {
                'line-cap': 'round',
                'line-join': 'round'
            }
        });

        const animationDuration = 30000; // Duration for the animation (30 seconds)
        const cameraAltitude = 500; // Adjusted altitude for better 3D effect

        let start;

        function frame(time) {
            if (!start) start = time;
            const phase = (time - start) / animationDuration;

            if (phase > 1) {
                return; // Stop the animation once it's finished
            }

            const alongRoute = turf.along(turf.lineString(route), routeDistance * phase).geometry.coordinates;
            const nextPoint = turf.along(turf.lineString(route), routeDistance * (phase + 0.001)).geometry.coordinates;

            const bearing = turf.bearing(
                turf.point(alongRoute),
                turf.point(nextPoint)
            );

            // Calculate pitch based on the distance between current and next point
            const pitch = calculatePitch(alongRoute, nextPoint);

            const cameraPosition = mapboxgl.MercatorCoordinate.fromLngLat({ lng: alongRoute[0], lat: alongRoute[1] }, cameraAltitude);
            const lookAtPoint = { lng: nextPoint[0], lat: nextPoint[1] };

            const camera = map.getFreeCameraOptions();
            camera.position = cameraPosition;
            camera.lookAtPoint(lookAtPoint);
            camera.pitch = pitch;
            camera.bearing = bearing;

            map.setFreeCameraOptions(camera);

            window.requestAnimationFrame(frame);
        }

        window.requestAnimationFrame(frame);
    });
};

// Function to calculate pitch based on the distance between current and next point
function calculatePitch(currentPoint, nextPoint) {
    const dx = nextPoint[0] - currentPoint[0];
    const dy = nextPoint[1] - currentPoint[1];
    const distance = Math.sqrt(dx * dx + dy * dy);
    // Adjust pitch based on distance, you can adjust this factor to your preference
    const pitch = Math.atan2(100, distance) * (180 / Math.PI);
    return pitch;
}

animateRoute();
</script>

</body>
</html>
